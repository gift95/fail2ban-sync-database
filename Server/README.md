# Fail2BanSync æœåŠ¡å™¨

![Fail2BanSync Logo](https://via.placeholder.com/80x80?text=F2BS)

## ï¿½ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [å®‰è£…æŒ‡å—](#å®‰è£…æŒ‡å—)
  - [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
  - [å¿«é€Ÿå®‰è£…](#å¿«é€Ÿå®‰è£…)
  - [å®‰è£…è¿‡ç¨‹è¯¦è§£](#å®‰è£…è¿‡ç¨‹è¯¦è§£)
  - [éªŒè¯å®‰è£…](#éªŒè¯å®‰è£…)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
  - [å®Œæ•´é…ç½®ç¤ºä¾‹](#å®Œæ•´é…ç½®ç¤ºä¾‹)
  - [é…ç½®é€‰é¡¹è¯¦è§£](#é…ç½®é€‰é¡¹è¯¦è§£)
- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
  - [Systemd æœåŠ¡æ§åˆ¶](#systemd-æœåŠ¡æ§åˆ¶)
  - [æŸ¥çœ‹æ—¥å¿—](#æŸ¥çœ‹æ—¥å¿—)
- [API ç«¯ç‚¹æ–‡æ¡£](#api-ç«¯ç‚¹æ–‡æ¡£)
  - [API åŸºç¡€ä¿¡æ¯](#api-åŸºç¡€ä¿¡æ¯)
  - [API ç«¯ç‚¹åˆ—è¡¨](#api-ç«¯ç‚¹åˆ—è¡¨)
- [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)
  - [è®¤è¯ä¸æˆæƒ](#è®¤è¯ä¸æˆæƒ)
  - [æ—¥å¿—å®‰å…¨](#æ—¥å¿—å®‰å…¨)
- [æ•°æ®åº“ç®¡ç†](#æ•°æ®åº“ç®¡ç†)
  - [æ•°æ®åº“ç»“æ„](#æ•°æ®åº“ç»“æ„)
  - [æ•°æ®åº“æ–‡ä»¶](#æ•°æ®åº“æ–‡ä»¶)
  - [æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤](#æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤)
- [å®¢æˆ·ç«¯ç®¡ç†](#å®¢æˆ·ç«¯ç®¡ç†)
  - [æ·»åŠ æ–°å®¢æˆ·ç«¯](#æ·»åŠ æ–°å®¢æˆ·ç«¯)
  - [ç§»é™¤å®¢æˆ·ç«¯](#ç§»é™¤å®¢æˆ·ç«¯)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
  - [å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ)
  - [è¯Šæ–­å‘½ä»¤](#è¯Šæ–­å‘½ä»¤)
- [å‡çº§æŒ‡å—](#å‡çº§æŒ‡å—)
  - [æœåŠ¡å™¨å‡çº§](#æœåŠ¡å™¨å‡çº§)
  - [é…ç½®å‡çº§](#é…ç½®å‡çº§)
- [æ€§èƒ½ä¸æ‰©å±•](#æ€§èƒ½ä¸æ‰©å±•)
  - [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [æ‰©å±•è€ƒè™‘](#æ‰©å±•è€ƒè™‘)
- [å¸¸è§éƒ¨ç½²åœºæ™¯](#å¸¸è§éƒ¨ç½²åœºæ™¯)
- [è´¡çŒ®æŒ‡å—](#è´¡çŒ®æŒ‡å—)
- [è®¸å¯è¯](#è®¸å¯è¯)
- [æ”¯æŒ](#æ”¯æŒ)
- [è”ç³»æˆ‘ä»¬](#è”ç³»æˆ‘ä»¬)

## ï¿½ğŸ“‹ é¡¹ç›®ç®€ä»‹

Fail2BanSync æœåŠ¡å™¨æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä¸­å¤®ç®¡ç†ç³»ç»Ÿï¼Œç”¨äºé›†ä¸­æ§åˆ¶å’ŒåŒæ­¥å¤šä¸ª Fail2Ban å®ä¾‹çš„ IP å°ç¦ç­–ç•¥ã€‚å®ƒæä¾›äº†ä¼ä¸šçº§çš„ API æœåŠ¡ï¼Œä½¿ç®¡ç†å‘˜èƒ½å¤Ÿåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ç»Ÿä¸€ç®¡ç†ç½‘ç»œå®‰å…¨ç­–ç•¥ï¼Œå®ç°è·¨æœåŠ¡å™¨çš„ IP å°ç¦ååŒå·¥ä½œã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- **ä¸­å¤®åŒ– IP ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰å®¢æˆ·ç«¯çš„å°ç¦å’Œå…è®¸ IP åˆ—è¡¨
- **RESTful API æ¥å£**ï¼šæä¾›æ ‡å‡†çš„ HTTP APIï¼Œä¾¿äºé›†æˆå’Œæ‰©å±•
- **å®‰å…¨è®¤è¯æœºåˆ¶**ï¼šä½¿ç”¨ Bearer-Token è¿›è¡Œå®¢æˆ·ç«¯è®¤è¯ï¼Œç¡®ä¿ API å®‰å…¨
- **é«˜æ€§èƒ½æ•°æ®å­˜å‚¨**ï¼šé‡‡ç”¨ SQLite æ•°æ®åº“ï¼Œé«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢ IP ä¿¡æ¯
- **æ™ºèƒ½å°ç¦ç­–ç•¥**ï¼šæ”¯æŒå¢é‡å°ç¦ã€è‡ªå®šä¹‰å°ç¦æ—¶é—´å’Œå°ç¦å› å­
- **è¯¦ç»†æ—¥å¿—è®°å½•**ï¼šå®Œæ•´è®°å½•ç³»ç»Ÿæ“ä½œå’Œ API è¯·æ±‚ï¼Œæ”¯æŒæ—¥å¿—è½®è½¬
- **å¯é çš„æœåŠ¡ç®¡ç†**ï¼šé€šè¿‡ systemd æä¾›è‡ªåŠ¨å¯åŠ¨ã€é‡å¯å’ŒçŠ¶æ€ç›‘æ§
- **å®¢æˆ·ç«¯æ ‡è¯†æ”¯æŒ**ï¼šè®°å½•å¹¶æ˜¾ç¤ºæ¯ä¸ªè¿æ¥å®¢æˆ·ç«¯çš„åç§°å’Œ IP åœ°å€

## ğŸš€ å®‰è£…æŒ‡å—

### å‰ææ¡ä»¶

- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 20.04 LTS æˆ–æ›´é«˜ç‰ˆæœ¬
- **Python 3**ï¼šéœ€è¦ Python 3.6 æˆ–æ›´é«˜ç‰ˆæœ¬
- **root æƒé™**ï¼šå®‰è£…è¿‡ç¨‹éœ€è¦ sudo æƒé™
- **ç½‘ç»œé…ç½®**ï¼šç¡®ä¿æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ 5000ï¼‰å¯è¢«å®¢æˆ·ç«¯è®¿é—®

### å¿«é€Ÿå®‰è£…

ä½¿ç”¨æä¾›çš„å®‰è£…è„šæœ¬è¿›è¡Œå¿«é€Ÿéƒ¨ç½²ï¼š

```bash
# 1. å…‹éš†é¡¹ç›®ï¼ˆæˆ–ä¸‹è½½ç›¸å…³æ–‡ä»¶ï¼‰
cd /tmp
git clone https://gitea.yxliu.cc/gift95/fail2ban-sync.git
cd fail2ban-sync/Server

# 2. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
chmod +x install_server.sh

# 3. è¿è¡Œå®‰è£…è„šæœ¬
./install_server.sh
```

### å®‰è£…è¿‡ç¨‹è¯¦è§£

å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **ç¯å¢ƒå‡†å¤‡**ï¼š
   - æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
   - å®‰è£… Python 3 å’Œ pip åŒ…ç®¡ç†å™¨
   - åˆ›å»ºä¸“ç”¨çš„ç³»ç»Ÿç”¨æˆ·å’Œç»„

2. **ç›®å½•ç»“æ„**ï¼š
   - åˆ›å»ºå®‰è£…ç›®å½•ï¼š`/opt/fail2bansync/`
   - è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™

3. **æ–‡ä»¶éƒ¨ç½²**ï¼š
   - å¤åˆ¶ `server.py` åˆ°å®‰è£…ç›®å½•
   - åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ `serverconfig.ini`
   - åˆå§‹åŒ– SQLite æ•°æ®åº“

4. **ä¾èµ–å®‰è£…**ï¼š
   - å®‰è£… Flask Web æ¡†æ¶
   - å®‰è£… Flask HTTPAuth è®¤è¯åº“
   - å®‰è£…å…¶ä»–å¿…è¦çš„ Python ä¾èµ–

5. **ä»¤ç‰Œç”Ÿæˆ**ï¼š
   - è‡ªåŠ¨ç”Ÿæˆ 9 ä¸ªå”¯ä¸€çš„å®¢æˆ·ç«¯è®¤è¯ä»¤ç‰Œ
   - åœ¨é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œè¿™äº›ä»¤ç‰Œ

6. **æœåŠ¡é…ç½®**ï¼š
   - åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
   - è®¾ç½®æœåŠ¡è‡ªåŠ¨å¯åŠ¨å’Œé‡å¯ç­–ç•¥
   - å¯åŠ¨ fail2bansync-server æœåŠ¡

### éªŒè¯å®‰è£…

å®‰è£…å®Œæˆåï¼ŒéªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status fail2bansync-server

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u fail2bansync-server -n 50
```

## âš™ï¸ é…ç½®è¯´æ˜

æœåŠ¡å™¨é€šè¿‡ `serverconfig.ini` æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œè¯¥æ–‡ä»¶ä½äº `/opt/fail2bansync/` ç›®å½•ã€‚

### å®Œæ•´é…ç½®ç¤ºä¾‹

```ini
[DEFAULT]
bantime = 10m            # é»˜è®¤å°ç¦æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
bantime.increment = true # æ˜¯å¦å¯ç”¨å¢é‡å°ç¦
bantime.factor = 3       # å¢é‡å°ç¦å› å­
bantime.maxtime = 5w     # æœ€å¤§å°ç¦æ—¶é—´ï¼ˆå‘¨ï¼‰
known_duration = 48h     # IP ä¿ç•™åœ¨å·²çŸ¥åˆ—è¡¨ä¸­çš„æ—¶é—´ï¼ˆå°æ—¶ï¼‰
allowed_duration = 2m    # IP ä¿ç•™åœ¨å…è®¸åˆ—è¡¨ä¸­çš„æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰

[api_tokens]
# ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ä»¤ç‰Œ
client1 = a1b2c3d4e5f6...
client2 = f6e5d4c3b2a1...
client3 = 1a2b3c4d5e6f...
# å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šå®¢æˆ·ç«¯ä»¤ç‰Œ
```

### é…ç½®é€‰é¡¹è¯¦è§£

#### [DEFAULT] éƒ¨åˆ†

| é…ç½®é¡¹ | æè¿° | é»˜è®¤å€¼ | ç¤ºä¾‹å€¼ |
|--------|------|--------|--------|
| `bantime` | é»˜è®¤çš„ IP å°ç¦æ—¶é—´ | 10m | 1h, 30m, 1d |
| `bantime.increment` | æ˜¯å¦å¯ç”¨å¢é‡å°ç¦æœºåˆ¶ | true | true, false |
| `bantime.factor` | å¢é‡å°ç¦çš„ä¹˜æ³•å› å­ | 3 | 2, 5, 10 |
| `bantime.maxtime` | æœ€å¤§çš„å°ç¦æ—¶é—´é™åˆ¶ | 5w | 1w, 2w, 4w |
| `known_duration` | IP åœ¨å·²çŸ¥åˆ—è¡¨ä¸­çš„ä¿ç•™æ—¶é—´ | 48h | 24h, 72h, 168h |
| `allowed_duration` | IP åœ¨å…è®¸åˆ—è¡¨ä¸­çš„ä¿ç•™æ—¶é—´ | 2m | 1m, 5m, 10m |

#### [api_tokens] éƒ¨åˆ†

ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯é…ç½®ä¸€ä¸ªå”¯ä¸€çš„è®¤è¯ä»¤ç‰Œï¼š

```ini
[api_tokens]
# æ ¼å¼ï¼šå®¢æˆ·ç«¯åç§° = è®¤è¯ä»¤ç‰Œ
client1 = 32å­—ç¬¦çš„åå…­è¿›åˆ¶ä»¤ç‰Œ
web_server = å¦ä¸€ä¸ª32å­—ç¬¦çš„åå…­è¿›åˆ¶ä»¤ç‰Œ
```

## ğŸ“Š æœåŠ¡ç®¡ç†

### Systemd æœåŠ¡æ§åˆ¶

| å‘½ä»¤ | ç”¨é€” |
|------|------|
| `sudo systemctl start fail2bansync-server` | å¯åŠ¨æœåŠ¡å™¨æœåŠ¡ |
| `sudo systemctl stop fail2bansync-server` | åœæ­¢æœåŠ¡å™¨æœåŠ¡ |
| `sudo systemctl restart fail2bansync-server` | é‡å¯æœåŠ¡å™¨æœåŠ¡ |
| `sudo systemctl status fail2bansync-server` | æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€ |
| `sudo systemctl enable fail2bansync-server` | è®¾ç½®å¼€æœºè‡ªå¯ |
| `sudo systemctl disable fail2bansync-server` | ç¦ç”¨å¼€æœºè‡ªå¯ |

æ¯æ¬¡ä¿®æ”¹ `server.py` æˆ– `serverconfig.ini` åï¼Œéœ€è¦é‡å¯æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹ï¼š

```bash
sudo systemctl restart fail2bansync-server
```

### æŸ¥çœ‹æ—¥å¿—

#### ç³»ç»ŸæœåŠ¡æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æœåŠ¡æ—¥å¿—
sudo journalctl -u fail2bansync-server -n 100

# å®æ—¶ç›‘æ§æœåŠ¡æ—¥å¿—
sudo journalctl -u fail2bansync-server -f

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—
sudo journalctl -u fail2bansync-server --since "1 hour ago"
```

#### åº”ç”¨ç¨‹åºæ—¥å¿—

æœåŠ¡å™¨åº”ç”¨æ—¥å¿—ä½äºï¼š`/opt/fail2bansync/server.log`

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
cat /opt/fail2bansync/server.log

# å®æ—¶ç›‘æ§åº”ç”¨æ—¥å¿—
tail -f /opt/fail2bansync/server.log

# æœç´¢æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
grep -i error /opt/fail2bansync/server.log
```

## ğŸ”Œ API ç«¯ç‚¹æ–‡æ¡£

### API åŸºç¡€ä¿¡æ¯

- **åŸºæœ¬ URL**ï¼š`http://æœåŠ¡å™¨IP:5000/`
- **è®¤è¯æ–¹å¼**ï¼šBearer Tokenï¼ˆåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  `Authorization: Bearer <token>`ï¼‰
- **å“åº”æ ¼å¼**ï¼šJSON
- **å®¢æˆ·ç«¯æ ‡è¯†**ï¼šæ”¯æŒåœ¨è®¤è¯å¤´ä¸­åŒ…å«å®¢æˆ·ç«¯åç§°ï¼ˆæ ¼å¼ï¼š`{"token": "<token>", "name": "<client_name>"}`ï¼‰

### API ç«¯ç‚¹åˆ—è¡¨

#### 1. ä¸Šä¼ æœ¬åœ°å°ç¦ IP

**POST /add_ips**

ç”¨äºå®¢æˆ·ç«¯å‘æœåŠ¡å™¨ä¸Šä¼ æœ¬åœ°å°ç¦çš„ IP åœ°å€ã€‚

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {"token": "å®¢æˆ·ç«¯ä»¤ç‰Œ", "name": "å®¢æˆ·ç«¯åç§°"}
Content-Type: application/json
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "ips": [
    {"ip": "192.168.1.100", "reason": "sshd", "time": "2023-11-10T12:00:00"},
    {"ip": "192.168.1.101", "reason": "sshd", "time": "2023-11-10T12:05:00"}
  ]
}
```

**å“åº”**ï¼š
```json
{"status": "success", "message": "IPs added successfully"}
```

#### 2. è·å–å…¨å±€å°ç¦ IP åˆ—è¡¨

**GET /get_ips**

è·å–æœåŠ¡å™¨ä¸Šæ‰€æœ‰éœ€è¦å…¨å±€å°ç¦çš„ IP åœ°å€åˆ—è¡¨ã€‚

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {"token": "å®¢æˆ·ç«¯ä»¤ç‰Œ", "name": "å®¢æˆ·ç«¯åç§°"}
```

**å“åº”**ï¼š
```json
{
  "ips": [
    {"ip": "192.168.1.100", "reason": "sshd", "time": "2023-11-10T12:00:00", "ban_until": "2023-11-10T12:10:00"},
    {"ip": "192.168.1.101", "reason": "sshd", "time": "2023-11-10T12:05:00", "ban_until": "2023-11-10T12:15:00"}
  ]
}
```

#### 3. è·å–å…è®¸çš„ IP åˆ—è¡¨

**GET /get_allowed_ips**

è·å–éœ€è¦ä»æœ¬åœ°å°ç¦åˆ—è¡¨ä¸­ç§»é™¤çš„ IP åœ°å€åˆ—è¡¨ã€‚

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {"token": "å®¢æˆ·ç«¯ä»¤ç‰Œ", "name": "å®¢æˆ·ç«¯åç§°"}
```

**å“åº”**ï¼š
```json
{
  "allowed_ips": ["192.168.1.200", "192.168.1.201"]
}
```

#### 4. è·å–æ‰€æœ‰å·²çŸ¥ IP ä¿¡æ¯

**GET /get_known_ips**

è·å–æœåŠ¡å™¨å·²çŸ¥çš„æ‰€æœ‰ IP åœ°å€åŠå…¶è¯¦ç»†ä¿¡æ¯ã€‚

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {"token": "å®¢æˆ·ç«¯ä»¤ç‰Œ", "name": "å®¢æˆ·ç«¯åç§°"}
```

**å“åº”**ï¼š
```json
{
  "known_ips": [
    {"ip": "192.168.1.100", "reason": "sshd", "time": "2023-11-10T12:00:00", "ban_until": "2023-11-10T12:10:00", "reported_by": "client1"},
    {"ip": "192.168.1.101", "reason": "sshd", "time": "2023-11-10T12:05:00", "ban_until": "2023-11-10T12:15:00", "reported_by": "client2"}
  ]
}
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### è®¤è¯ä¸æˆæƒ

1. **ä»¤ç‰Œç®¡ç†**ï¼š
   - ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…å”¯ä¸€çš„è®¤è¯ä»¤ç‰Œ
   - å®šæœŸè½®æ¢ä»¤ç‰Œä»¥å¢å¼ºå®‰å…¨æ€§
   - ç«‹å³æ’¤é”€æ³„éœ²çš„ä»¤ç‰Œ

2. **è®¿é—®æ§åˆ¶**ï¼š
   - é™åˆ¶å¯¹é…ç½®æ–‡ä»¶çš„è®¿é—®æƒé™ï¼š`sudo chmod 600 /opt/fail2bansync/serverconfig.ini`
   - ç¡®ä¿æ•°æ®åº“æ–‡ä»¶å®‰å…¨ï¼š`sudo chmod 600 /opt/fail2bansync/ip_management.db`

3. **ç½‘ç»œå®‰å…¨**ï¼š
   - è€ƒè™‘åœ¨é˜²ç«å¢™ä¸­é™åˆ¶å¯¹æœåŠ¡å™¨ç«¯å£çš„è®¿é—®
   - ä»…å…è®¸å—ä¿¡ä»»ç½‘ç»œçš„å®¢æˆ·ç«¯è¿æ¥
   - å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨ HTTPS åè®®

### æ—¥å¿—å®‰å…¨

- å®šæœŸå®¡æŸ¥æ—¥å¿—æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å¼‚å¸¸æ´»åŠ¨
- ç¡®ä¿æ—¥å¿—æ–‡ä»¶ä¸è¢«æœªæˆæƒè®¿é—®
- è€ƒè™‘é…ç½®æ—¥å¿—é›†ä¸­ç®¡ç†ç³»ç»Ÿ

## ğŸ“Š æ•°æ®åº“ç®¡ç†

### æ•°æ®åº“ç»“æ„

Fail2BanSync ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹è¡¨ç»“æ„ï¼š

- **banned_ips**ï¼šå­˜å‚¨å½“å‰è¢«å°ç¦çš„ IP ä¿¡æ¯
- **allowed_ips**ï¼šå­˜å‚¨éœ€è¦å…è®¸çš„ IP ä¿¡æ¯
- **known_ips**ï¼šå­˜å‚¨æœåŠ¡å™¨å·²çŸ¥çš„æ‰€æœ‰ IP å†å²ä¿¡æ¯

### æ•°æ®åº“æ–‡ä»¶

- **ä½ç½®**ï¼š`/opt/fail2bansync/ip_management.db`
- **å¤‡ä»½**ï¼šå»ºè®®å®šæœŸå¤‡ä»½æ­¤æ–‡ä»¶

### æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤

**å¤‡ä»½æ•°æ®åº“**ï¼š

```bash
# åˆ›å»ºæ•°æ®åº“å¤‡ä»½
sudo cp /opt/fail2bansync/ip_management.db /opt/fail2bansync/ip_management.db.backup

# åˆ›å»ºå®šæ—¶å¤‡ä»½ï¼ˆå¯æ·»åŠ åˆ° crontabï¼‰
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰
0 2 * * * cp /opt/fail2bansync/ip_management.db /opt/fail2bansync/ip_management.db.$(date +\%Y\%m\%d)
```

**æ¢å¤æ•°æ®åº“**ï¼š

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop fail2bansync-server

# æ¢å¤å¤‡ä»½
sudo cp /opt/fail2bansync/ip_management.db.backup /opt/fail2bansync/ip_management.db

# å¯åŠ¨æœåŠ¡
sudo systemctl start fail2bansync-server
```

## ğŸ”§ å®¢æˆ·ç«¯ç®¡ç†

### æ·»åŠ æ–°å®¢æˆ·ç«¯

1. **ç”Ÿæˆæ–°ä»¤ç‰Œ**ï¼š

```bash
# ä½¿ç”¨ openssl ç”Ÿæˆå®‰å…¨ä»¤ç‰Œ
openssl rand -hex 32
```

2. **æ·»åŠ åˆ°é…ç½®æ–‡ä»¶**ï¼š

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /opt/fail2bansync/serverconfig.ini

# åœ¨ [api_tokens] éƒ¨åˆ†æ·»åŠ æ–°å®¢æˆ·ç«¯
[api_tokens]
client1 = existing_token1
client2 = existing_token2
new_client = newly_generated_token
```

3. **é‡å¯æœåŠ¡**ï¼š

```bash
sudo systemctl restart fail2bansync-server
```

4. **é…ç½®å®¢æˆ·ç«¯**ï¼š

ä¸ºæ–°å®¢æˆ·ç«¯æä¾›ä»¤ç‰Œï¼Œç”¨äºå…¶ `clientconfig.ini` æ–‡ä»¶ï¼š

```ini
[auth]
token = newly_generated_token
```

### ç§»é™¤å®¢æˆ·ç«¯

1. **ä»é…ç½®æ–‡ä»¶ä¸­åˆ é™¤ä»¤ç‰Œ**ï¼š

```bash
sudo nano /opt/fail2bansync/serverconfig.ini
# åˆ é™¤å¯¹åº”çš„å®¢æˆ·ç«¯ä»¤ç‰Œè¡Œ
```

2. **é‡å¯æœåŠ¡**ï¼š

```bash
sudo systemctl restart fail2bansync-server
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼š
- `systemctl status` æ˜¾ç¤ºæœåŠ¡å¯åŠ¨å¤±è´¥
- æ—¥å¿—ä¸­å‡ºç°é”™è¯¯ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
sudo systemctl status fail2bansync-server
sudo journalctl -u fail2bansync-server -n 100 --no-pager

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 5000

# æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼
sudo python3 -m configparser /opt/fail2bansync/serverconfig.ini

# æ‰‹åŠ¨è¿è¡ŒæœåŠ¡å™¨è¿›è¡Œè°ƒè¯•
cd /opt/fail2bansync
sudo python3 server.py
```

#### 2. å®¢æˆ·ç«¯æ— æ³•è¿æ¥

**ç—‡çŠ¶**ï¼š
- å®¢æˆ·ç«¯æ—¥å¿—æ˜¾ç¤ºè¿æ¥é”™è¯¯
- æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤ºè®¤è¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
sudo systemctl status fail2bansync-server

# éªŒè¯å®¢æˆ·ç«¯ä»¤ç‰Œæ˜¯å¦æ­£ç¡®
grep -A 10 "\[api_tokens\]" /opt/fail2bansync/serverconfig.ini

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw status

# æµ‹è¯• API è¿æ¥
curl -X GET http://localhost:5000/get_ips -H "Authorization: Bearer client1_token"
```

#### 3. æ•°æ®åº“é”™è¯¯

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—ä¸­æ˜¾ç¤ºæ•°æ®åº“ç›¸å…³é”™è¯¯
- API è¿”å›æ•°æ®åº“é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
sudo ls -la /opt/fail2bansync/ip_management.db

# éªŒè¯æ•°æ®åº“å®Œæ•´æ€§
sudo sqlite3 /opt/fail2bansync/ip_management.db "PRAGMA integrity_check;"

# å¦‚æœæ•°æ®åº“æŸåï¼Œä»å¤‡ä»½æ¢å¤
```

#### 4. æ€§èƒ½é—®é¢˜

**ç—‡çŠ¶**ï¼š
- API å“åº”ç¼“æ…¢
- æœåŠ¡å™¨èµ„æºä½¿ç”¨ç‡é«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
top -u fail2bansync

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°
du -h /opt/fail2bansync/server.log*

# è€ƒè™‘ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo sqlite3 /opt/fail2bansync/ip_management.db "CREATE INDEX IF NOT EXISTS idx_banned_ips_ip ON banned_ips(ip);"
```

### è¯Šæ–­å‘½ä»¤

```bash
# æ£€æŸ¥ Python ç‰ˆæœ¬
python3 --version

# æ£€æŸ¥å®‰è£…çš„ Python åŒ…
pip3 list | grep -E 'flask|sqlite3'

# æµ‹è¯•ç½‘ç»œè¿æ¥
ping å®¢æˆ·ç«¯IP
telnet å®¢æˆ·ç«¯IP 5000

# æ£€æŸ¥æœåŠ¡å™¨ç›‘å¬ç«¯å£
netstat -tulpn | grep 5000

# æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½
uptime

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
```

## ğŸ”„ å‡çº§æŒ‡å—

### æœåŠ¡å™¨å‡çº§

```bash
# 1. åœæ­¢å½“å‰æœåŠ¡
sudo systemctl stop fail2bansync-server

# 2. å¤‡ä»½å½“å‰é…ç½®å’Œæ•°æ®åº“
cp /opt/fail2bansync/serverconfig.ini /tmp/
cp /opt/fail2bansync/ip_management.db /tmp/

# 3. ä¸‹è½½æ–°ç‰ˆæœ¬çš„ server.py
cd /opt/fail2bansync
sudo curl -s -o server.py https://gitea.yxliu.cc/gift95/fail2ban-sync/raw/branch/main/Server/server.py

# 4. æ¢å¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæ–°ç‰ˆæœ¬æœ‰é…ç½®å˜æ›´ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨åˆå¹¶ï¼‰
cp /tmp/serverconfig.ini /opt/fail2bansync/

# 5. é‡å¯æœåŠ¡
sudo systemctl start fail2bansync-server

# 6. éªŒè¯æœåŠ¡çŠ¶æ€
sudo systemctl status fail2bansync-server
```

### é…ç½®å‡çº§

å½“å‡çº§åˆ°æ–°ç‰ˆæœ¬æ—¶ï¼Œå¯èƒ½éœ€è¦æ›´æ–°é…ç½®æ–‡ä»¶ä»¥æ”¯æŒæ–°åŠŸèƒ½ã€‚è¯·å‚è€ƒæœ€æ–°çš„é…ç½®ç¤ºä¾‹è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚

## ğŸ“ˆ æ€§èƒ½ä¸æ‰©å±•

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **æ—¥å¿—è½®è½¬**ï¼šç¡®ä¿æ—¥å¿—æ–‡ä»¶ä¸ä¼šå˜å¾—è¿‡å¤§
- **æ•°æ®åº“ç»´æŠ¤**ï¼šå®šæœŸå¤‡ä»½å’Œä¼˜åŒ–æ•°æ®åº“
- **èµ„æºç›‘æ§**ï¼šç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶è°ƒæ•´é…ç½®
- **ç½‘ç»œä¼˜åŒ–**ï¼šç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®šï¼Œè€ƒè™‘ä½¿ç”¨ HTTPS åŠ é€Ÿ

### æ‰©å±•è€ƒè™‘

- **å¤šæœåŠ¡å™¨éƒ¨ç½²**ï¼šå¯¹äºå¤§è§„æ¨¡éƒ¨ç½²ï¼Œè€ƒè™‘ä½¿ç”¨ä¸»ä»æ¶æ„
- **è´Ÿè½½å‡è¡¡**ï¼šå¦‚æœéœ€è¦æ”¯æŒå¤§é‡å®¢æˆ·ç«¯ï¼Œå¯ä»¥é…ç½®è´Ÿè½½å‡è¡¡
- **å¤–éƒ¨æ•°æ®åº“**ï¼šå¯¹äºéå¸¸å¤§çš„éƒ¨ç½²ï¼Œå¯ä»¥è€ƒè™‘è¿ç§»åˆ° PostgreSQL æˆ– MySQL

## ğŸ“ å¸¸è§éƒ¨ç½²åœºæ™¯

### åœºæ™¯ 1ï¼šå°å‹ç¯å¢ƒï¼ˆ1-10 å°æœåŠ¡å™¨ï¼‰

- å•æœåŠ¡å™¨éƒ¨ç½² Fail2BanSync æœåŠ¡
- æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥åˆ°åŒä¸€ä¸­å¤®æœåŠ¡å™¨
- ä½¿ç”¨é»˜è®¤é…ç½®å³å¯æ»¡è¶³éœ€æ±‚

### åœºæ™¯ 2ï¼šä¸­å‹ç¯å¢ƒï¼ˆ11-50 å°æœåŠ¡å™¨ï¼‰

- å•æœåŠ¡å™¨éƒ¨ç½²ï¼Œå¯èƒ½éœ€è¦å¢åŠ ç³»ç»Ÿèµ„æº
- è€ƒè™‘ä½¿ç”¨ HTTPS åè®®å¢å¼ºå®‰å…¨æ€§
- é…ç½®æ—¥å¿—é›†ä¸­ç®¡ç†
- å®šæœŸå¤‡ä»½æ•°æ®åº“

### åœºæ™¯ 3ï¼šå¤§å‹ç¯å¢ƒï¼ˆ50+ å°æœåŠ¡å™¨ï¼‰

- è€ƒè™‘é«˜å¯ç”¨éƒ¨ç½²æ–¹æ¡ˆ
- å¯èƒ½éœ€è¦è¿ç§»åˆ°æ›´å¼ºå¤§çš„æ•°æ®åº“ç³»ç»Ÿ
- å®æ–½ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶å’Œç›‘æ§
- è€ƒè™‘ä½¿ç”¨ API ç½‘å…³è¿›è¡Œè¯·æ±‚ç®¡ç†

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºè´¡çŒ®ï¼å¦‚æœæ‚¨æƒ³å‚ä¸é¡¹ç›®å¼€å‘ï¼š

1. Fork æœ¬é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ï¼ˆ`git checkout -b feature/AmazingFeature`ï¼‰
3. æäº¤æ›´æ”¹ï¼ˆ`git commit -m 'Add some AmazingFeature'`ï¼‰
4. æ¨é€åˆ°åˆ†æ”¯ï¼ˆ`git push origin feature/AmazingFeature`ï¼‰
5. æ‰“å¼€ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](https://gitea.yxliu.cc/gift95/fail2ban-sync/src/branch/main/LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ†˜ æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤) éƒ¨åˆ†
2. æŸ¥çœ‹ [æœåŠ¡å™¨æ—¥å¿—](#æŸ¥çœ‹æ—¥å¿—) è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. æŸ¥çœ‹é¡¹ç›®çš„ [Gitea Issues](https://gitea.yxliu.cc/gift95/fail2ban-sync/issues) é¡µé¢
4. è”ç³»é¡¹ç›®ç»´æŠ¤è€…è·å–æ”¯æŒ

## ğŸ“ è”ç³»æˆ‘ä»¬

- **é¡¹ç›®ä¸»é¡µ**ï¼š[https://gitea.yxliu.cc/gift95/fail2ban-sync](https://gitea.yxliu.cc/gift95/fail2ban-sync)
- **æ–‡æ¡£**ï¼š[README.md](README.md)
- **é—®é¢˜åé¦ˆ**ï¼š[Gitea Issues](https://gitea.yxliu.cc/gift95/fail2ban-sync/issues)

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´11æœˆ  
**ç‰ˆæœ¬**ï¼šv2.0.0  
**Fail2BanSync - ä¼ä¸šçº§ IP å°ç¦ç®¡ç†è§£å†³æ–¹æ¡ˆ**