# Fail2BanSync â€“ Fail2Bançš„IPåŒæ­¥ç³»ç»Ÿ


## ğŸ“‘ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
  - [æœåŠ¡å™¨ç»„ä»¶](#æœåŠ¡å™¨ç»„ä»¶)
  - [å®¢æˆ·ç«¯ç»„ä»¶](#å®¢æˆ·ç«¯ç»„ä»¶)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
  - [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
  - [æœåŠ¡å™¨å®‰è£…](#æœåŠ¡å™¨å®‰è£…)
  - [å®¢æˆ·ç«¯å®‰è£…](#å®¢æˆ·ç«¯å®‰è£…)
- [å®‰å…¨æ€§ä¸ç”Ÿäº§ç¯å¢ƒ](#å®‰å…¨æ€§ä¸ç”Ÿäº§ç¯å¢ƒ)
- [æ‰©å±•ä¸å®šåˆ¶](#æ‰©å±•ä¸å®šåˆ¶)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [å‡çº§æŒ‡å—](#å‡çº§æŒ‡å—)
- [è®¸å¯è¯](#è®¸å¯è¯)
- [è”ç³»æˆ‘ä»¬](#è”ç³»æˆ‘ä»¬)

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

Fail2BanSync æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä¸­å¤® IP åŒæ­¥ç³»ç»Ÿï¼Œä¸“é—¨ä¸ºè¿è¡Œ Fail2Ban çš„æœåŠ¡å™¨é›†ç¾¤è®¾è®¡ã€‚è¯¥ç³»ç»Ÿå…è®¸åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´é›†ä¸­æ”¶é›†ã€åŒæ­¥å’Œç®¡ç†è¢«å°ç¦å’Œå…è®¸çš„ IP åœ°å€ï¼Œä»è€Œæé«˜æ•´ä½“å®‰å…¨æ€§å’Œé˜²å¾¡èƒ½åŠ›ã€‚

ç³»ç»Ÿæ¶æ„é‡‡ç”¨æœåŠ¡å™¨-å®¢æˆ·ç«¯æ¨¡å¼ï¼Œç”±å¸¦æœ‰ä»¤ç‰Œè®¤è¯çš„ä¸­å¤® REST-API æœåŠ¡å™¨å’Œä»»æ„æ•°é‡çš„åŒæ­¥å®¢æˆ·ç«¯ç»„æˆï¼Œç¡®ä¿åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„é«˜æ•ˆååŒå·¥ä½œã€‚Fail2BanSync é€šè¿‡ AI å·¥å…·è¿›è¡Œè¾…åŠ©æ„å»ºå’Œé…ç½®ã€‚ çµæ„Ÿæ¥è‡ª [davidus05] (https://github.com/davidus05/fail2ban-sync)

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- **ä¸­å¤®åŒ–ç®¡ç†**ï¼šåŸºäº Flask çš„ REST-API æœåŠ¡å™¨ï¼Œæä¾›ä»¤ç‰Œè®¤è¯æœºåˆ¶
- **æ™ºèƒ½ IP åŒæ­¥**ï¼šè‡ªåŠ¨æ”¶é›†å’Œåˆ†å‘è¢«å°ç¦/å…è®¸çš„ IP åœ°å€
- **é«˜æ•ˆæ•°æ®å­˜å‚¨**ï¼šä½¿ç”¨ SQLite æ•°æ®åº“è¿›è¡Œ IP ä¿¡æ¯ç®¡ç†
- **çµæ´»é…ç½®**ï¼šå¯å®šåˆ¶çš„å°ç¦æ—¶é—´ã€é˜»æ­¢å’Œé‡Šæ”¾å‘¨æœŸé€»è¾‘
- **å®Œå–„çš„ç›‘æ§**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•ã€é”™è¯¯å¤„ç†å’Œ systemd é›†æˆ
- **ç®€å•éƒ¨ç½²**ï¼šæä¾›å…¨è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼ˆæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼‰
- **å®‰å…¨è®¤è¯**ï¼šåŸºäº Bearer-Token çš„å®¢æˆ·ç«¯èº«ä»½éªŒè¯

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æœåŠ¡å™¨ç»„ä»¶

- **API æœåŠ¡**ï¼šåœ¨ç«¯å£ 5000ï¼ˆé»˜è®¤ï¼‰ä¸Šæä¾› REST-API æ¥å£
- **æ•°æ®å­˜å‚¨**ï¼šåœ¨ SQLite æ•°æ®åº“ä¸­å­˜å‚¨è¢«å°ç¦/å…è®¸çš„ IP ä¿¡æ¯
- **è®¤è¯æœºåˆ¶**ï¼šé€šè¿‡ Bearer-Token éªŒè¯å®¢æˆ·ç«¯èº«ä»½
- **æœåŠ¡ç®¡ç†**ï¼šä½œä¸º systemd æœåŠ¡æŒç»­è¿è¡Œ
- **é…ç½®ç®¡ç†**ï¼šæä¾›ç¤ºä¾‹é…ç½®å’Œè‡ªåŠ¨ç”Ÿæˆå¤šå®¢æˆ·ç«¯ä»¤ç‰Œ

### å®¢æˆ·ç«¯ç»„ä»¶

- **IP æ”¶é›†**ï¼šä»æœ¬åœ° Fail2Ban æŸ¥è¯¢è¢«å°ç¦çš„ IP åœ°å€
- **æ•°æ®åŒæ­¥**ï¼šå°†æœ¬åœ°å°ç¦ IP å‘é€åˆ°ä¸­å¤®æœåŠ¡å™¨
- **ç­–ç•¥æ‰§è¡Œ**ï¼šä»ä¸­å¤®è·å–å°ç¦/å…è®¸åˆ—è¡¨å¹¶ä¸æœ¬åœ° Fail2Ban åŒæ­¥
- **å®šæ—¶ä»»åŠ¡**ï¼šä½œä¸º systemd æœåŠ¡æ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu Server 20.04 LTS æˆ–æ›´é«˜ç‰ˆæœ¬
- **Python 3**ï¼šéœ€è¦ Python 3.6 æˆ–æ›´é«˜ç‰ˆæœ¬
- **æƒé™**ï¼šå®‰è£…è¿‡ç¨‹éœ€è¦ root æƒé™
- **Fail2Ban**ï¼šå®¢æˆ·ç«¯æœåŠ¡å™¨éœ€å·²å®‰è£…å¹¶é…ç½® Fail2Ban

### æœåŠ¡å™¨å®‰è£…

1. **å‡†å¤‡å®‰è£…æ–‡ä»¶**ï¼š
   ```bash
   # å…‹éš†é¡¹ç›®
   git clone https://gitea.yxliu.cc/gift95/fail2ban-sync.git
   cd fail2ban-sync/Server
   ```

2. **æ‰§è¡Œå®‰è£…è„šæœ¬**ï¼š
   ```bash
   chmod +x install_server.sh
   ./install_server.sh
   ```

3. **é…ç½®æœåŠ¡å™¨**ï¼š
   æ ¹æ®éœ€è¦ç¼–è¾‘ `/opt/fail2bansync/serverconfig.ini` æ–‡ä»¶ï¼Œè°ƒæ•´ä»¤ç‰Œå’Œå…¶ä»–é…ç½®é¡¹ã€‚

4. **éªŒè¯å®‰è£…**ï¼š
   ```bash
   sudo systemctl status fail2bansync-server
   ```

5. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   æœåŠ¡å™¨æ—¥å¿—ä½äºï¼š`/opt/fail2bansync/server.log`

### å®¢æˆ·ç«¯å®‰è£…

1. **å‡†å¤‡å®‰è£…æ–‡ä»¶**ï¼š
   ```bash
   # åœ¨å®¢æˆ·ç«¯æœåŠ¡å™¨ä¸Šå…‹éš†é¡¹ç›®
   git clone https://gitea.yxliu.cc/gift95/fail2ban-sync.git
   cd fail2ban-sync/Client
   ```

2. **æ‰§è¡Œå®‰è£…è„šæœ¬**ï¼š
   ```bash
   chmod +x install_client.sh
   ./install_client.sh
   ```

3. **é…ç½®å®¢æˆ·ç«¯**ï¼š
   ç¼–è¾‘ `/opt/fail2bansync-client/clientconfig.ini` æ–‡ä»¶ï¼Œè¾“å…¥æœåŠ¡å™¨ IP åœ°å€å’Œè®¤è¯ä»¤ç‰Œã€‚

4. **éªŒè¯å®‰è£…**ï¼š
   ```bash
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   sudo systemctl status fail2bansync-client
   # æŸ¥çœ‹æ—¥å¿—
   tail -f /opt/fail2bansync-client/client.log
   ```

## ğŸ”’ å®‰å…¨æ€§ä¸ç”Ÿäº§ç¯å¢ƒ

### æœ€ä½³å®‰å…¨å®è·µ

- **åå‘ä»£ç†**ï¼šå§‹ç»ˆåœ¨ NGINX/Apache åé¢è¿è¡ŒæœåŠ¡å™¨ APIï¼Œå¹¶é…ç½® HTTPS åŠ å¯†
- **ä»¤ç‰Œç®¡ç†**ï¼šå®‰å…¨ä¿ç®¡è®¤è¯ä»¤ç‰Œï¼Œå®šæœŸè½®æ¢å¹¶åˆ é™¤ä¸å†ä½¿ç”¨çš„ä»¤ç‰Œ
- **æ•°æ®ä¿æŠ¤**ï¼šå®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶ (`/opt/fail2bansync/ip_management.db`)
- **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶æœåŠ¡å™¨ç«¯å£åªæ¥å—æ¥è‡ªå—ä¿¡ä»» IP çš„è¿æ¥
- **æ—¥å¿—ç›‘æ§**ï¼šè®¾ç½®æ—¥å¿—ç›‘æ§ç³»ç»Ÿï¼Œæ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

```bash
# æ¨èçš„é˜²ç«å¢™é…ç½®
sudo ufw allow from 192.168.1.0/24 to any port 5000 proto tcp

# ä¸º API è®¾ç½® HTTPS (ä½¿ç”¨ NGINX)
sudo apt install nginx
# é…ç½® SSL è¯ä¹¦å’Œåå‘ä»£ç†
```

## ğŸ› ï¸ æ‰©å±•ä¸å®šåˆ¶

### åŠŸèƒ½æ‰©å±•

- **å®¢æˆ·ç«¯ç®¡ç†**ï¼šé€šè¿‡æœåŠ¡å™¨é…ç½®è½»æ¾æ·»åŠ æˆ–ç§»é™¤å®¢æˆ·ç«¯
  ```bash
  # æ·»åŠ æ–°å®¢æˆ·ç«¯ä»¤ç‰Œåˆ°æœåŠ¡å™¨é…ç½®
  sudo nano /opt/fail2bansync/serverconfig.ini
  # åœ¨ [api_tokens] éƒ¨åˆ†æ·»åŠ æ–°æ¡ç›®
  ```

- **è‡ªå®šä¹‰å°ç¦ç­–ç•¥**ï¼šè°ƒæ•´æœåŠ¡å™¨é…ç½®ä¸­çš„å°ç¦å‚æ•°
  ```ini
  [DEFAULT]
  bantime = 15m          # è°ƒæ•´é»˜è®¤å°ç¦æ—¶é—´
  bantime.increment = true
  bantime.factor = 2    # è°ƒæ•´å¢é‡å› å­
  ```

### ç›‘æ§é›†æˆ

- å¯ä»¥ä¸ Prometheusã€Grafana ç­‰ç›‘æ§å·¥å…·é›†æˆ
- é€šè¿‡ API ç«¯ç‚¹è·å–ç³»ç»ŸçŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯

## ğŸš§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   - æ£€æŸ¥æ—¥å¿—ï¼š`/opt/fail2bansync/server.log`
   - éªŒè¯ç«¯å£å¯ç”¨æ€§ï¼š`netstat -tulpn | grep 5000`
   - æ£€æŸ¥ä¾èµ–å®‰è£…ï¼š`pip3 list | grep flask`

2. **å®¢æˆ·ç«¯è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼š`sudo systemctl status fail2bansync-server`
   - éªŒè¯ç½‘ç»œè¿æ¥ï¼š`ping æœåŠ¡å™¨IP`
   - ç¡®è®¤ä»¤ç‰Œæ­£ç¡®ï¼šæ£€æŸ¥å®¢æˆ·ç«¯é…ç½®ä¸­çš„ä»¤ç‰Œ

3. **è®¤è¯é”™è¯¯**
   - æ£€æŸ¥ HTTP 401 é”™è¯¯ï¼ŒéªŒè¯ä»¤ç‰ŒåŒ¹é…
   - ç¡®è®¤æœåŠ¡å™¨é…ç½®ä¸­çš„ä»¤ç‰Œåˆ—è¡¨åŒ…å«å®¢æˆ·ç«¯ä»¤ç‰Œ

4. **IP åŒæ­¥é—®é¢˜**
   - æ£€æŸ¥å®¢æˆ·ç«¯æ—¥å¿—ï¼š`/opt/fail2bansync-client/client.log`
   - éªŒè¯ Fail2Ban æœåŠ¡è¿è¡Œæ­£å¸¸ï¼š`sudo systemctl status fail2ban`

### è¯Šæ–­å‘½ä»¤

```bash
# æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
sudo systemctl status fail2bansync-server

# æ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€
sudo systemctl status fail2bansync-client

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -n 50 /opt/fail2bansync/server.log

# æŸ¥çœ‹å®¢æˆ·ç«¯æ—¥å¿—
tail -n 50 /opt/fail2bansync-client/client.log

# æµ‹è¯• API è¿æ¥
curl -X GET http://æœåŠ¡å™¨IP:5000/get_ips -H "Authorization: Bearer å®¢æˆ·ç«¯ä»¤ç‰Œ"

# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sudo sqlite3 /opt/fail2bansync/ip_management.db "PRAGMA integrity_check;"
```

## ğŸ”„ å‡çº§æŒ‡å—

### æœåŠ¡å™¨å‡çº§

```bash
# 1. åœæ­¢å½“å‰æœåŠ¡
sudo systemctl stop fail2bansync-server

# 2. å¤‡ä»½æ•°æ®åº“
cp /opt/fail2bansync/ip_management.db /opt/fail2bansync/ip_management.db.backup

# 3. æ›¿æ¢æœåŠ¡å™¨æ–‡ä»¶
cp server.py /opt/fail2bansync/

# 4. é‡å¯æœåŠ¡
sudo systemctl start fail2bansync-server

# 5. éªŒè¯å‡çº§
sudo systemctl status fail2bansync-server
```

### å®¢æˆ·ç«¯å‡çº§

```bash
# 1. åœæ­¢å½“å‰æœåŠ¡
sudo systemctl stop fail2bansync-client

# 2. æ›¿æ¢å®¢æˆ·ç«¯æ–‡ä»¶
cp client.py /opt/fail2bansync-client/

# 3. é‡å¯æœåŠ¡
sudo systemctl start fail2bansync-client

# 4. éªŒè¯å‡çº§
sudo systemctl status fail2bansync-client
```

### é…ç½®å‡çº§

- æ–°å®¢æˆ·ç«¯ä»¤ç‰Œå¯ä»¥éšæ—¶æ·»åŠ åˆ°æœåŠ¡å™¨é…ç½®ä¸­ï¼Œæ— éœ€é‡å¯æœåŠ¡
- é…ç½®æ–‡ä»¶æ›´æ–°åéœ€è¦é‡å¯ç›¸åº”æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦æƒ…è¯·å‚é˜… [LICENSE](https://gitea.yxliu.cc/gift95/fail2ban-sync/src/branch/main/LICENSE) æ–‡ä»¶ã€‚

## ğŸ“ è”ç³»æˆ‘ä»¬

å¦‚æœ‰ç–‘é—®ã€å»ºè®®æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚

- **é¡¹ç›®ä¸»é¡µ**ï¼š[https://gitea.yxliu.cc/gift95/fail2ban-sync](https://gitea.yxliu.cc/gift95/fail2ban-sync)
- **é—®é¢˜åé¦ˆ**ï¼š[https://gitea.yxliu.cc/gift95/fail2ban-sync/issues](https://gitea.yxliu.cc/gift95/fail2ban-sync/issues)

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025å¹´11æœˆ  
**ç‰ˆæœ¬**ï¼šv2.0.0  

**Fail2BanSync â€“ ç°ä»£åŒ–å¤šæœåŠ¡å™¨ IP å°ç¦ååŒè§£å†³æ–¹æ¡ˆ**


